<template>
  <div class="flashburner-container">
    <div class="mode-tabs-card">
      <button
        :class="{active: mode==='GBA'}"
        @click="mode='GBA'"
      >
        <span class="tab-icon">üéÆ</span> GBA
      </button>
      <button
        :class="{active: mode==='MBC5'}"
        @click="mode='MBC5'"
      >
        <span class="tab-icon">üïπÔ∏è</span> MBC5
      </button>
    </div>
    <div class="main-layout">
      <div class="content-area">
        <div class="status-row">
          <span
            v-if="busy"
            class="status busy"
          >Êìç‰Ωú‰∏≠...</span>
          <span
            v-if="result"
            class="status"
          >{{ result }}</span>
        </div>
        <section class="section">
          <h2>ËäØÁâáÊìç‰Ωú</h2>
          <div class="button-row">
            <button
              :disabled="!deviceReady || busy"
              @click="readID"
            >
              ËØªÂèñID
            </button>
            <button
              :disabled="!deviceReady || busy"
              @click="eraseChip"
            >
              ÂÖ®ÁâáÊì¶Èô§
            </button>
          </div>
          <div
            v-if="idStr"
            class="id-display"
          >
            ID: {{ idStr }}
          </div>
        </section>
        <section class="section">
          <h2>ROM Êìç‰Ωú</h2>
          <div class="file-upload-area">
            <div 
              class="file-drop-zone"
              :class="{ 
                'has-file': romFileData,
                'drag-over': romDragOver,
                'disabled': !deviceReady || busy
              }"
              @click="triggerRomFileSelect"
              @dragover.prevent="handleRomDragOver"
              @dragleave.prevent="handleRomDragLeave"
              @drop.prevent="handleRomDrop"
            >
              <input 
                ref="romFileInput"
                type="file" 
                :disabled="!deviceReady || busy" 
                style="display: none"
                accept=".rom,.gba,.gb,.gbc"
                @change="onRomFileChange"
              >
              <div
                v-if="!romFileData"
                class="drop-zone-content"
              >
                <div class="upload-icon">
                  üìÅ
                </div>
                <div class="upload-text">
                  <p class="main-text">
                    ÁÇπÂáªÈÄâÊã©ROMÊñá‰ª∂
                  </p>
                  <p class="sub-text">
                    ÊàñÊãñÊãΩÊñá‰ª∂Âà∞Ê≠§Â§Ñ
                  </p>
                  <p class="hint-text">
                    ÊîØÊåÅ .rom, .gba, .gb, .gbc Ê†ºÂºè
                  </p>
                </div>
              </div>
              <div
                v-else
                class="file-preview"
              >
                <div class="file-icon">
                  üéÆ
                </div>
                <div class="file-details">
                  <div class="file-name">
                    {{ romFileName }}
                  </div>
                  <div class="file-size">
                    {{ formatFileSize(romFileData.length) }}
                  </div>
                  <div class="file-type">
                    ROM Êñá‰ª∂
                  </div>
                </div>
                <button 
                  class="remove-file-btn"
                  :disabled="busy"
                  @click.stop="clearRomFile"
                >
                  ‚úï
                </button>
              </div>
            </div>
          </div>
          <div class="button-row">
            <button
              :disabled="!deviceReady || !romFileData || busy"
              @click="writeToDevice"
            >
              ÂÜôÂÖ•ROM
            </button>
            <button
              :disabled="!deviceReady || busy"
              @click="readRom"
            >
              ÂØºÂá∫ROM
            </button>
            <button
              :disabled="!deviceReady || !romFileData || busy"
              @click="verifyRom"
            >
              Ê†°È™åROM
            </button>
          </div>
          <div
            v-if="writeProgress !== null"
            class="progress-row"
          >
            <progress
              :value="writeProgress"
              max="100"
            />
            <span>{{ writeProgress }}%</span>
            <span v-if="writeDetail">{{ writeDetail }}</span>
          </div>
        </section>
        <section class="section">
          <h2>RAM Êìç‰Ωú</h2>
          <div
            v-if="mode === 'GBA'"
            class="ram-content"
          >
            <div class="file-upload-area">
              <div 
                class="file-drop-zone"
                :class="{ 
                  'has-file': ramFileData,
                  'drag-over': ramDragOver,
                  'disabled': !deviceReady || busy
                }"
                @click="triggerRamFileSelect"
                @dragover.prevent="handleRamDragOver"
                @dragleave.prevent="handleRamDragLeave"
                @drop.prevent="handleRamDrop"
              >
                <input 
                  ref="ramFileInput"
                  type="file" 
                  :disabled="!deviceReady || busy" 
                  style="display: none"
                  accept=".sav,.ram"
                  @change="onRamFileChange"
                >
                <div
                  v-if="!ramFileData"
                  class="drop-zone-content"
                >
                  <div class="upload-icon">
                    üíæ
                  </div>
                  <div class="upload-text">
                    <p class="main-text">
                      ÁÇπÂáªÈÄâÊã©RAMÊñá‰ª∂
                    </p>
                    <p class="sub-text">
                      ÊàñÊãñÊãΩÊñá‰ª∂Âà∞Ê≠§Â§Ñ
                    </p>
                    <p class="hint-text">
                      ÊîØÊåÅ .sav, .ram Ê†ºÂºè
                    </p>
                  </div>
                </div>
                <div
                  v-else
                  class="file-preview"
                >
                  <div class="file-icon">
                    üíæ
                  </div>
                  <div class="file-details">
                    <div class="file-name">
                      {{ ramFileName }}
                    </div>
                    <div class="file-size">
                      {{ formatFileSize(ramFileData.length) }}
                    </div>
                    <div class="file-type">
                      RAM Êñá‰ª∂
                    </div>
                  </div>
                  <button 
                    class="remove-file-btn"
                    :disabled="busy"
                    @click.stop="clearRamFile"
                  >
                    ‚úï
                  </button>
                </div>
              </div>
            </div>
            <div class="button-row">
              <button
                :disabled="!deviceReady || !ramFileData || busy"
                @click="writeRam"
              >
                ÂÜôÂÖ•RAM
              </button>
              <button
                :disabled="!deviceReady || busy"
                @click="readRam"
              >
                ÂØºÂá∫RAM
              </button>
              <button
                :disabled="!deviceReady || !ramFileData || busy"
                @click="verifyRam"
              >
                Ê†°È™åRAM
              </button>
            </div>
            <div
              v-if="ramWriteProgress !== null"
              class="progress-row"
            >
              <progress
                :value="ramWriteProgress"
                max="100"
              />
              <span>{{ ramWriteProgress }}%</span>
              <span v-if="ramWriteDetail">{{ ramWriteDetail }}</span>
            </div>
          </div>
          <div
            v-else
            class="mode-info"
          >
            <p>üí° MBC5 Ê®°Âºè‰∏ã RAM Êìç‰Ωú‰∏çÂèØÁî®</p>
          </div>
        </section>
      </div>
      
      <div class="log-section">
        <div class="log-header">
          <h2>Êó•Âøó</h2>
          <button
            class="log-clear"
            @click="clearLog"
          >
            Ê∏ÖÁ©∫
          </button>
        </div>
        <div
          ref="logBox"
          class="log-area-scroll"
        >
          <div
            v-for="(line, idx) in logs"
            :key="idx"
            class="log-line"
          >
            {{ line }}
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, watch, nextTick } from 'vue'
import { 
  // GBA Commands
  rom_readID, rom_eraseChip, rom_direct_write, rom_read, rom_verify, 
  ram_write, ram_read, ram_verify,
  // GBC Commands
  gbc_direct_write, gbc_read
} from '../utils/protocol.js'

const props = defineProps({
  // eslint-disable-next-line vue/require-default-prop
  device: Object,
  deviceReady: Boolean
})

const mode = ref('GBA')
const busy = ref(false)
const result = ref('')
const idStr = ref('')
const romFileData = ref(null)
const romFileName = ref('')
const ramFileData = ref(null)
const ramFileName = ref('')
const writeProgress = ref(null)
const writeDetail = ref('')
const ramWriteProgress = ref(null)
const ramWriteDetail = ref('')
const logs = ref([])
const logBox = ref(null)

// ÊãñÊãΩÁä∂ÊÄÅ
const romDragOver = ref(false)
const ramDragOver = ref(false)

// Êñá‰ª∂ËæìÂÖ•ÂºïÁî®
const romFileInput = ref(null)
const ramFileInput = ref(null)

function log(msg) {
  const time = new Date().toLocaleTimeString()
  logs.value.push(`[${time}] ${msg}`)
  if (logs.value.length > 500) logs.value.shift()
}
function clearLog() {
  logs.value = []
}

watch(logs, async () => {
  await nextTick()
  if (logBox.value) {
    logBox.value.scrollTop = logBox.value.scrollHeight
  }
})

function onRomFileChange(e) {
  const file = e.target.files[0]
  if (!file) return
  processRomFile(file)
}

function onRamFileChange(e) {
  const file = e.target.files[0]
  if (!file) return
  processRamFile(file)
}

function processRomFile(file) {
  romFileName.value = file.name
  const reader = new FileReader()
  reader.onload = () => {
    romFileData.value = new Uint8Array(reader.result)
    log(`Â∑≤ÈÄâÊã©ROMÊñá‰ª∂: ${romFileName.value}ÔºåÂ§ßÂ∞è${formatFileSize(romFileData.value.length)}`)
  }
  reader.readAsArrayBuffer(file)
}

function processRamFile(file) {
  ramFileName.value = file.name
  const reader = new FileReader()
  reader.onload = () => {
    ramFileData.value = new Uint8Array(reader.result)
    log(`Â∑≤ÈÄâÊã©RAMÊñá‰ª∂: ${ramFileName.value}ÔºåÂ§ßÂ∞è${formatFileSize(ramFileData.value.length)}`)
  }
  reader.readAsArrayBuffer(file)
}

// Ê†ºÂºèÂåñÊñá‰ª∂Â§ßÂ∞è
function formatFileSize(bytes) {
  if (bytes === 0) return '0 B'
  const k = 1024
  const sizes = ['B', 'KB', 'MB', 'GB']
  const i = Math.floor(Math.log(bytes) / Math.log(k))
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i]
}

// ROM Êñá‰ª∂Áõ∏ÂÖ≥
function triggerRomFileSelect() {
  if (!props.deviceReady || busy.value) return
  romFileInput.value.click()
}

function clearRomFile() {
  romFileData.value = null
  romFileName.value = ''
  if (romFileInput.value) romFileInput.value.value = ''
  log('Â∑≤Ê∏ÖÈô§ROMÊñá‰ª∂ÈÄâÊã©')
}

function handleRomDragOver(e) {
  if (!props.deviceReady || busy.value) return
  romDragOver.value = true
}

function handleRomDragLeave() {
  romDragOver.value = false
}

function handleRomDrop(e) {
  romDragOver.value = false
  if (!props.deviceReady || busy.value) return
  
  const files = e.dataTransfer.files
  if (files.length > 0) {
    processRomFile(files[0])
  }
}

// RAM Êñá‰ª∂Áõ∏ÂÖ≥
function triggerRamFileSelect() {
  if (!props.deviceReady || busy.value) return
  ramFileInput.value.click()
}

function clearRamFile() {
  ramFileData.value = null
  ramFileName.value = ''
  if (ramFileInput.value) ramFileInput.value.value = ''
  log('Â∑≤Ê∏ÖÈô§RAMÊñá‰ª∂ÈÄâÊã©')
}

function handleRamDragOver(e) {
  if (!props.deviceReady || busy.value) return
  ramDragOver.value = true
}

function handleRamDragLeave() {
  ramDragOver.value = false
}

function handleRamDrop(e) {
  ramDragOver.value = false
  if (!props.deviceReady || busy.value) return
  
  const files = e.dataTransfer.files
  if (files.length > 0) {
    processRamFile(files[0])
  }
}

async function readID() {
  busy.value = true
  result.value = ''
  log(`[${mode.value}] ÂºÄÂßãËØªÂèñID`)
  try {
    const id = await rom_readID(props.device)
    idStr.value = id.map(x => x.toString(16).padStart(2, '0')).join(' ')
    result.value = 'ËØªÂèñIDÊàêÂäü'
    log(`[${mode.value}] ËØªÂèñIDÊàêÂäü: ${idStr.value}`)
  } catch (e) {
    result.value = 'ËØªÂèñIDÂ§±Ë¥•: ' + e
    log(`[${mode.value}] ËØªÂèñIDÂ§±Ë¥•: ${e}`)
  }
  busy.value = false
}

async function eraseChip() {
  busy.value = true
  result.value = ''
  log(`[${mode.value}] ÂºÄÂßãÂÖ®ÁâáÊì¶Èô§`)
  try {
    await rom_eraseChip(props.device)
    result.value = 'Êì¶Èô§ÊàêÂäü'
    log(`[${mode.value}] Êì¶Èô§ÊàêÂäü`)
  } catch (e) {
    result.value = 'Êì¶Èô§Â§±Ë¥•: ' + e
    log(`[${mode.value}] Êì¶Èô§Â§±Ë¥•: ${e}`)
  }
  busy.value = false
}

async function writeToDevice() {
  busy.value = true
  result.value = ''
  writeProgress.value = 0
  writeDetail.value = ''
  log(`[${mode.value}] ÂºÄÂßãÂÜôÂÖ•ROMÔºåÂ§ßÂ∞è${romFileData.value.length}Â≠óËäÇ`)
  try {
    const total = romFileData.value.length
    let written = 0
    const pageSize = 256
    
    // Ê†πÊçÆÊ®°ÂºèÈÄâÊã©ÂÜôÂÖ•ÂáΩÊï∞
    const writeFunction = mode.value === 'GBA' ? rom_direct_write : gbc_direct_write
    
    // ÂàÜÂùóÂÜôÂÖ•Âπ∂Êõ¥Êñ∞ËøõÂ∫¶
    for (let addr = 0; addr < total; addr += pageSize) {
      const chunk = romFileData.value.slice(addr, Math.min(addr + pageSize, total))
      await writeFunction(props.device, chunk, addr) // ‰ΩøÁî® baseAddress ÂèÇÊï∞
      written += chunk.length
      writeProgress.value = Math.floor((written / total) * 100)
      writeDetail.value = `${written} / ${total} Â≠óËäÇ`
      if (written % (pageSize * 16) === 0) log(`[${mode.value}] Â∑≤ÂÜôÂÖ•${written}Â≠óËäÇ`)
    }
    writeProgress.value = 100
    result.value = 'ÂÜôÂÖ•ÊàêÂäü'
    log(`[${mode.value}] ÂÜôÂÖ•ROMÂÆåÊàê`)
  } catch (e) {
    result.value = 'ÂÜôÂÖ•Â§±Ë¥•: ' + e
    log(`[${mode.value}] ÂÜôÂÖ•ROMÂ§±Ë¥•: ${e}`)
  }
  busy.value = false
  setTimeout(() => { writeProgress.value = null; writeDetail.value = '' }, 1500)
}

async function readRom() {
  busy.value = true
  result.value = ''
  log(`[${mode.value}] ÂºÄÂßãÂØºÂá∫ROM`)
  try {
    // Ê†πÊçÆÊ®°ÂºèÈÄâÊã©ËØªÂèñÂáΩÊï∞
    const readFunction = mode.value === 'GBA' ? rom_read : gbc_read
    const defaultSize = romFileData.value ? romFileData.value.length : 0x200000
    const data = await readFunction(props.device, defaultSize)
    result.value = `ÂØºÂá∫ROMÊàêÂäüÔºåÂ§ßÂ∞èÔºö${data.length} Â≠óËäÇ`
    log(`[${mode.value}] ÂØºÂá∫ROMÊàêÂäüÔºåÂ§ßÂ∞èÔºö${data.length} Â≠óËäÇ`)
    saveAsFile(data, 'exported.rom')
  } catch (e) {
    result.value = 'ÂØºÂá∫ROMÂ§±Ë¥•: ' + e
    log(`[${mode.value}] ÂØºÂá∫ROMÂ§±Ë¥•: ${e}`)
  }
  busy.value = false
}

async function verifyRom() {
  busy.value = true
  result.value = ''
  log(`[${mode.value}] ÂºÄÂßãÊ†°È™åROM`)
  try {
    const ok = await rom_verify(props.device, romFileData.value)
    result.value = ok ? 'Ê†°È™åÈÄöËøá' : 'Ê†°È™åÂ§±Ë¥•'
    log(`[${mode.value}] Ê†°È™åROM: ${ok ? 'ÈÄöËøá' : 'Â§±Ë¥•'}`)
  } catch (e) {
    result.value = 'Ê†°È™åÂ§±Ë¥•: ' + e
    log(`[${mode.value}] Ê†°È™åROMÂ§±Ë¥•: ${e}`)
  }
  busy.value = false
}

async function writeRam() {
  busy.value = true
  result.value = ''
  ramWriteProgress.value = 0
  ramWriteDetail.value = ''
  log(`[${mode.value}] ÂºÄÂßãÂÜôÂÖ•RAMÔºåÂ§ßÂ∞è${ramFileData.value.length}Â≠óËäÇ`)
  try {
    const total = ramFileData.value.length
    let written = 0
    const pageSize = 256
    
    // ÂàÜÂùóÂÜôÂÖ•Âπ∂Êõ¥Êñ∞ËøõÂ∫¶
    for (let addr = 0; addr < total; addr += pageSize) {
      const chunk = ramFileData.value.slice(addr, Math.min(addr + pageSize, total))
      await ram_write(props.device, chunk, addr) // ‰ΩøÁî® baseAddress ÂèÇÊï∞
      written += chunk.length
      ramWriteProgress.value = Math.floor((written / total) * 100)
      ramWriteDetail.value = `${written} / ${total} Â≠óËäÇ`
      if (written % (pageSize * 16) === 0) log(`[${mode.value}] Â∑≤ÂÜôÂÖ•RAM ${written}Â≠óËäÇ`)
    }
    ramWriteProgress.value = 100
    result.value = 'RAMÂÜôÂÖ•ÊàêÂäü'
    log(`[${mode.value}] ÂÜôÂÖ•RAMÂÆåÊàê`)
  } catch (e) {
    result.value = 'RAMÂÜôÂÖ•Â§±Ë¥•: ' + e
    log(`[${mode.value}] ÂÜôÂÖ•RAMÂ§±Ë¥•: ${e}`)
  }
  busy.value = false
  setTimeout(() => { ramWriteProgress.value = null; ramWriteDetail.value = '' }, 1500)
}

async function readRam() {
  busy.value = true
  result.value = ''
  log(`[${mode.value}] ÂºÄÂßãÂØºÂá∫RAM`)
  try {
    const data = await ram_read(props.device, ramFileData.value ? ramFileData.value.length : 0x8000)
    result.value = `ÂØºÂá∫RAMÊàêÂäüÔºåÂ§ßÂ∞èÔºö${data.length} Â≠óËäÇ`
    log(`[${mode.value}] ÂØºÂá∫RAMÊàêÂäüÔºåÂ§ßÂ∞èÔºö${data.length} Â≠óËäÇ`)
    saveAsFile(data, 'exported.sav')
  } catch (e) {
    result.value = 'ÂØºÂá∫RAMÂ§±Ë¥•: ' + e
    log(`[${mode.value}] ÂØºÂá∫RAMÂ§±Ë¥•: ${e}`)
  }
  busy.value = false
}

async function verifyRam() {
  busy.value = true
  result.value = ''
  log(`[${mode.value}] ÂºÄÂßãÊ†°È™åRAM`)
  try {
    const ok = await ram_verify(props.device, ramFileData.value)
    result.value = ok ? 'RAMÊ†°È™åÈÄöËøá' : 'RAMÊ†°È™åÂ§±Ë¥•'
    log(`[${mode.value}] Ê†°È™åRAM: ${ok ? 'ÈÄöËøá' : 'Â§±Ë¥•'}`)
  } catch (e) {
    result.value = 'RAMÊ†°È™åÂ§±Ë¥•: ' + e
    log(`[${mode.value}] Ê†°È™åRAMÂ§±Ë¥•: ${e}`)
  }
  busy.value = false
}

function saveAsFile(data, filename) {
  const blob = new Blob([data], { type: 'application/octet-stream' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}
</script>

<style scoped>
.flashburner-container {
  max-width: 1200px;
  margin: 32px auto;
  padding: 24px 32px;
  background: #fafbfc;
  border-radius: 14px;
  box-shadow: 0 2px 16px #0002;
  font-family: 'Segoe UI', 'PingFang SC', Arial, sans-serif;
}

/* ÂìçÂ∫îÂºè‰∏ªÂ∏ÉÂ±Ä */
.main-layout {
  display: flex;
  gap: 24px;
  height: 820px;
  align-items: stretch;
}

/* ÂÜÖÂÆπÂå∫Âüü */
.content-area {
  flex: 1;
  min-width: 0;
  display: flex;
  flex-direction: column;
  overflow-y: auto;
  padding-right: 8px;
}

/* ÁæéÂåñÊªöÂä®Êù° */
.content-area::-webkit-scrollbar {
  width: 6px;
}

.content-area::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 3px;
}

.content-area::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 3px;
}

.content-area::-webkit-scrollbar-thumb:hover {
  background: #a1a1a1;
}

.log-section {
  width: 350px;
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
  height: 820px; /* ‰∏é‰∏ªÂ∏ÉÂ±ÄÁõ∏ÂêåÁöÑÂõ∫ÂÆöÈ´òÂ∫¶ */
}

.log-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  flex-shrink: 0; /* Èò≤Ê≠¢ header Ë¢´ÂéãÁº© */
  height: 32px; /* Âõ∫ÂÆö header È´òÂ∫¶ */
}

.log-header h2 {
  margin: 0;
  font-size: 1.1rem;
  color: #333;
}

.log-clear {
  background: #f44336;
  color: white;
  border: none;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.8rem;
  cursor: pointer;
}

.log-clear:hover {
  background: #d32f2f;
}

.log-area-scroll {
  background: #f4f4f4;
  border-radius: 6px;
  border: 1px solid #ccc;
  padding: 8px 8px 8px 12px;
  flex: 1; /* Âç†Áî®Ââ©‰ΩôÁ©∫Èó¥ */
  overflow-y: auto;
  font-family: monospace;
  font-size: 0.97rem;
  line-height: 1.6;
  height: calc(820px - 44px); /* ÊÄªÈ´òÂ∫¶ÂáèÂéª header È´òÂ∫¶Âíå margin */
}

/* Êó•ÂøóÂå∫ÂüüÊªöÂä®Êù°Ê†∑Âºè */
.log-area-scroll::-webkit-scrollbar {
  width: 6px;
}

.log-area-scroll::-webkit-scrollbar-track {
  background: #e8e8e8;
  border-radius: 3px;
}

.log-area-scroll::-webkit-scrollbar-thumb {
  background: #bbb;
  border-radius: 3px;
}

.log-area-scroll::-webkit-scrollbar-thumb:hover {
  background: #999;
}

/* ÁßªÂä®Á´ØÂìçÂ∫îÂºè */
@media (max-width: 768px) {
  .flashburner-container {
    margin: 16px;
    padding: 16px 20px;
  }
  
  .main-layout {
    flex-direction: column;
    gap: 20px;
    height: auto; /* ÁßªÂä®Á´ØÂèñÊ∂àÂõ∫ÂÆöÈ´òÂ∫¶ */
  }
  
  .content-area {
    width: 100%;
    overflow-y: visible; /* ÁßªÂä®Á´ØÂèñÊ∂àÊªöÂä® */
    padding-right: 0; /* ÁßªÂä®Á´Ø‰∏çÈúÄË¶ÅÊªöÂä®Êù°Á©∫Èó¥ */
  }
  
  .log-section {
    width: 100%;
    height: 350px; /* ÁßªÂä®Á´ØÁªôÊó•ÂøóÂå∫ÂüüËÆæÁΩÆÂõ∫ÂÆöÈ´òÂ∫¶ */
  }
  
  .log-area-scroll {
    height: calc(350px - 44px) !important; /* ÁßªÂä®Á´ØÊó•ÂøóÊªöÂä®Âå∫ÂüüÈ´òÂ∫¶ */
  }
}
.mode-tabs-card {
  display: flex;
  gap: 0;
  margin-bottom: 22px;
  background: #e3f2fd;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 1px 4px #0001;
}
.mode-tabs-card button {
  flex: 1 1 0;
  border: none;
  background: none;
  padding: 12px 0 10px 0;
  font-size: 1.08rem;
  font-weight: 600;
  color: #1976d2;
  background: #e3f2fd;
  transition: background 0.2s, color 0.2s;
  cursor: pointer;
  border-bottom: 2px solid transparent;
  display: flex;
  align-items: center;
  justify-content: center;
}
.mode-tabs-card button.active {
  background: #fff;
  color: #1565c0;
  border-bottom: 2.5px solid #1976d2;
  z-index: 1;
}
.tab-icon {
  margin-right: 6px;
  font-size: 1.2em;
}
.section {
  margin-bottom: 28px;
}
.section h2 {
  font-size: 1.15rem;
  margin-bottom: 10px;
  color: #2c3e50;
  font-weight: 600;
}
.button-row {
  display: flex;
  gap: 16px;
  margin-bottom: 8px;
  flex-wrap: wrap;
}

/* Êñ∞ÁöÑÊñá‰ª∂‰∏ä‰º†Âå∫ÂüüÊ†∑Âºè */
.file-upload-area {
  margin-bottom: 12px;
}

.file-drop-zone {
  border: 2px dashed #d1d5db;
  border-radius: 8px;
  padding: 16px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  background: #fafbfc;
  min-height: 80px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.file-drop-zone:hover:not(.disabled) {
  border-color: #1976d2;
  background: #f8faff;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(25, 118, 210, 0.1);
}

.file-drop-zone.drag-over {
  border-color: #1976d2;
  background: #e3f2fd;
  transform: scale(1.02);
}

.file-drop-zone.has-file {
  border-color: #4caf50;
  background: #f1f8e9;
  border-style: solid;
}

.file-drop-zone.disabled {
  cursor: not-allowed;
  opacity: 0.6;
  border-color: #e0e0e0;
  background: #f5f5f5;
}

.drop-zone-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  width: 100%;
}

.upload-icon {
  font-size: 2rem;
  margin-bottom: 4px;
  opacity: 0.7;
}

.upload-text {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.main-text {
  font-size: 0.95rem;
  font-weight: 600;
  color: #2c3e50;
  margin: 0;
}

.sub-text {
  font-size: 0.85rem;
  color: #6c757d;
  margin: 0;
}

.hint-text {
  font-size: 0.75rem;
  color: #9ca3af;
  margin: 0;
}

.file-preview {
  display: flex;
  align-items: center;
  gap: 12px;
  width: 100%;
  padding: 6px 8px;
  background: white;
  border-radius: 6px;
  box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
}

.file-icon {
  font-size: 1.8rem;
  opacity: 0.8;
}

.file-details {
  flex: 1;
  text-align: left;
}

.file-name {
  font-size: 0.9rem;
  font-weight: 600;
  color: #2c3e50;
  margin-bottom: 2px;
  word-break: break-all;
}

.file-size {
  font-size: 0.8rem;
  color: #6c757d;
  margin-bottom: 1px;
}

.file-type {
  font-size: 0.75rem;
  color: #4caf50;
  font-weight: 500;
}

.remove-file-btn {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  border: 1px solid #dc3545;
  background: #fff;
  color: #dc3545;
  font-size: 0.8rem;
  font-weight: bold;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  padding: 0;
}

.remove-file-btn:hover:not(:disabled) {
  background: #dc3545;
  color: white;
  transform: scale(1.1);
}

.remove-file-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
.id-display {
  margin-top: 6px;
  color: #1976d2;
  font-weight: bold;
  letter-spacing: 2px;
}
.status-row {
  margin-top: 18px;
  min-height: 24px;
}
.status {
  font-size: 1rem;
  color: #333;
}
.status.busy {
  color: #e67e22;
  font-weight: bold;
}
.progress-row {
  display: flex;
  align-items: center;
  gap: 12px;
  margin: 8px 0;
}
progress {
  width: 180px;
  height: 16px;
}

.log-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 8px;
}
.log-header h2 {
  font-size: 1.08rem;
  color: #1976d2;
  margin: 0;
}
.log-clear {
  background: #f5f7fa;
  border: 1px solid #bbb;
  border-radius: 5px;
  padding: 2px 14px;
  font-size: 0.98rem;
  color: #888;
  cursor: pointer;
  transition: background 0.2s, color 0.2s;
}
.log-clear:hover {
  background: #e3f2fd;
  color: #1976d2;
}

.log-line {
  white-space: pre-wrap;
  word-break: break-all;
}
button {
  padding: 6px 18px;
  border-radius: 5px;
  border: 1px solid #bbb;
  background: #f5f7fa;
  cursor: pointer;
  font-size: 1rem;
  transition: background 0.2s, color 0.2s;
}
button:disabled {
  background: #eee;
  color: #aaa;
  cursor: not-allowed;
}
button:not(:disabled):hover {
  background: #e3f2fd;
  color: #1976d2;
}
input[type="file"] {
  margin-left: 8px;
}
.mode-info {
  padding: 12px 16px;
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 6px;
  color: #6c757d;
  font-size: 0.95rem;
}
.mode-info p {
  margin: 0;
  display: flex;
  align-items: center;
  gap: 8px;
}
</style>
