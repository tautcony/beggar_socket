# beggar_socket
A lightweight gba cartridge burner, with limited functionality

# pcb和原理图

[sch_pcb](https://oshwhub.com/linscon/beggar_socket)

# 协议&命令

- 单片机的usb虚拟了一个串口，vid: 0x0483 pid: 0x0721
- 发送dtr置位复位信号可以重置单片机内的命令buffer(其实发rts信号也行，但windows自带<br>
  的串口驱动的rts不是实时的，不建议)。
- 以下所有的crc都是没用的，不论填什么都不会影响功能。毕竟usb自带校验，每个包再算一次<br>
  还浪费性能，干脆无视。
- 都是小端模式
- **重要更新**：协议响应格式已优化：
  - **有数据返回的命令**（如获取版本信息、读取数据等）：仍保留CRC + 数据的格式
  - **无数据状态返回的命令**（如擦除、编程、跳转等）：简化为只返回状态字节，不再包含CRC
  - **错误响应**：返回2字节（0xFF + 错误码），不包含CRC

## GBA命令

### 获取rom id

- 发送

| 字节数 | 2         | 1    | 2   |
| ------ | --------- | ---- | --- |
| 定义   | 包大小(5) | 0xf0 | CRC |

- 返回

| 字节数 | 2   | 8                                  |
| ------ | --- | ---------------------------------- |
| 定义   | CRC | ID<br> Autoselect 第0、1、15、16字 |

### rom 全片抹除

- 发送

| 字节数 | 2         | 1    | 2   |
| ------ | --------- | ---- | --- |
| 定义   | 包大小(5) | 0xf1 | CRC |

- 返回 （只是执行擦除命令，擦完没有另行判断）

| 字节数 | 1                        |
| ------ | ------------------------ |
| 定义   | 0xaa(成功)<br>其它(失败) |

### rom 扇区擦除(64KB)

- 发送

| 字节数 | 2         | 1    | 4        | 2   |
| ------ | --------- | ---- | -------- | --- |
| 定义   | 包大小(9) | 0xf3 | 扇区地址 | CRC |

- 返回 （擦完才返回）

| 字节数 | 1                        |
| ------ | ------------------------ |
| 定义   | 0xaa(成功)<br>其它(失败) |

### rom 编程

- 发送

| 字节数 | 2                   | 1    | 4              | 2                                     | n    | 2   |
| ------ | ------------------- | ---- | -------------- | ------------------------------------- | ---- | --- |
| 定义   | 包大小(2+1+4+2+n+2) | 0xf4 | 起始地址(字节) | rom buffer大小<br>0表示只能单字节编程 | 数据 | CRC |

- 返回

| 字节数 | 1                        |
| ------ | ------------------------ |
| 定义   | 0xaa(成功)<br>其它(失败) |

### rom 直接写(透传)

- 发送

| 字节数 | 2                 | 1    | 4        | n                           | 2   |
| ------ | ----------------- | ---- | -------- | --------------------------- | --- |
| 定义   | 包大小(2+1+4+n+2) | 0xf5 | 地址(字) | 数据<br>2-5000<br>n=2的倍数 | CRC |

- 返回

| 字节数 | 1                        |
| ------ | ------------------------ |
| 定义   | 0xaa(成功)<br>其它(失败) |

### rom 读取

- 发送

| 字节数 | 2          | 1    | 4              | 2                                  | 2   |
| ------ | ---------- | ---- | -------------- | ---------------------------------- | --- |
| 定义   | 包大小(11) | 0xf6 | 起始地址(字节) | 读取n个字节<br>2-5000<br>n=2的倍数 | CRC |

- 返回

| 字节数 | 2   | n    |
| ------ | --- | ---- |
| 定义   | CRC | 数据 |

### ram 写入

> 切bank通过上位机完成

- 发送

| 字节数 | 2                 | 1    | 4              | n                | 2   |
| ------ | ----------------- | ---- | -------------- | ---------------- | --- |
| 定义   | 包大小(2+1+4+n+2) | 0xf7 | 起始地址(字节) | 数据<br>n=1-5000 | CRC |

- 返回

| 字节数 | 1                        |
| ------ | ------------------------ |
| 定义   | 0xaa(成功)<br>其它(失败) |

### ram 读取

> 切bank通过上位机完成

- 发送

| 字节数 | 2          | 1    | 4              | 2                       | 2   |
| ------ | ---------- | ---- | -------------- | ----------------------- | --- |
| 定义   | 包大小(11) | 0xf8 | 起始地址(字节) | 读取n个字节<br>n=1-5000 | CRC |

- 返回

| 字节数 | 2   | n    |
| ------ | --- | ---- |
| 定义   | CRC | 数据 |


### ram 写入FLASH

> 切bank通过上位机完成

- 发送

| 字节数 | 2                 | 1    | 4              | n                | 2   |
| ------ | ----------------- | ---- | -------------- | ---------------- | --- |
| 定义   | 包大小(2+1+4+n+2) | 0xf9 | 起始地址(字节) | 数据<br>n=1-5000 | CRC |

- 返回

| 字节数 | 1                        |
| ------ | ------------------------ |
| 定义   | 0xaa(成功)<br>其它(失败) |

## GBC命令

### gbc 直接写(透传)

- 发送

| 字节数 | 2                 | 1    | 4    | n              | 2   |
| ------ | ----------------- | ---- | ---- | -------------- | --- |
| 定义   | 包大小(2+1+4+n+2) | 0xfa | 起始地址(字节) | 数据<br>1-5000 | CRC |

- 返回

| 字节数 | 1                        |
| ------ | ------------------------ |
| 定义   | 0xaa(成功)<br>其它(失败) |

### gbc 读取

> 切bank通过上位机完成

- 发送

| 字节数 | 2          | 1    | 4              | 2                       | 2   |
| ------ | ---------- | ---- | -------------- | ----------------------- | --- |
| 定义   | 包大小(11) | 0xfb | 起始地址(字节) | 读取n个字节<br>n=1-5000 | CRC |

- 返回

| 字节数 | 2   | n    |
| ------ | --- | ---- |
| 定义   | CRC | 数据 |

### gbc rom 编程

- 发送

| 字节数 | 2                   | 1    | 4              | 2                                     | n    | 2   |
| ------ | ------------------- | ---- | -------------- | ------------------------------------- | ---- | --- |
| 定义   | 包大小(2+1+4+2+n+2) | 0xfc | 起始地址(字节) | rom buffer大小<br>0表示只能单字节编程 | 数据 | CRC |

- 返回

| 字节数 | 1                        |
| ------ | ------------------------ |
| 定义   | 0xaa(成功)<br>其它(失败) |

## IAP系统升级命令

### 获取版本信息

> 在应用程序模式下返回应用程序版本信息

- 发送

| 字节数 | 2         | 1    | 1    | 2   |
| ------ | --------- | ---- | ---- | --- |
| 定义   | 包大小(6) | 0xff | 0x00 | CRC |

- 返回

| 字节数 | 2   | 1      | 1      | 1      | 2        | 4        | 1        | 1        | n              |
| ------ | --- | ------ | ------ | ------ | -------- | -------- | -------- | -------- | -------------- |
| 定义   | CRC | 主版本 | 次版本 | 补丁号 | 构建号   | 时间戳   | 版本类型 | 字符串长度 | 版本字符串     |

**版本类型说明：**
- 0: Bootloader版本
- 1: Application版本

### 重启到bootloader模式

- 发送

| 字节数 | 2         | 1    | 1    | 2   |
| ------ | --------- | ---- | ---- | --- |
| 定义   | 包大小(6) | 0xff | 0xff | CRC |

- 返回

| 字节数 | 1                                      |
| ------ | -------------------------------------- |
| 定义   | 0xaa(成功)<br>其它值(失败，参见错误码表) |

## Bootloader命令

> 设备重启到bootloader模式后支持的命令

### 获取bootloader版本信息

> 在bootloader模式下返回bootloader版本信息

- 发送

| 字节数 | 2         | 1    | 1    | 2   |
| ------ | --------- | ---- | ---- | --- |
| 定义   | 包大小(6) | 0xff | 0x00 | CRC |

- 返回

| 字节数 | 2   | 1      | 1      | 1      | 2        | 4        | 1        | 1        | n              |
| ------ | --- | ------ | ------ | ------ | -------- | -------- | -------- | -------- | -------------- |
| 定义   | CRC | 主版本 | 次版本 | 补丁号 | 构建号   | 时间戳   | 版本类型 | 字符串长度 | 版本字符串     |

**版本类型说明：**
- 0: Bootloader版本
- 1: Application版本

### 擦除Flash

- 发送

| 字节数 | 2          | 1    | 1    | 4      | 4      | 2   |
| ------ | ---------- | ---- | ---- | ------ | ------ | --- |
| 定义   | 包大小(14) | 0xff | 0x01 | 起始地址 | 擦除大小 | CRC |

- 返回

| 字节数 | 1                                      |
| ------ | -------------------------------------- |
| 定义   | 0xaa(成功)<br>其它值(失败，参见错误码表) |

### 编程Flash

- 发送

| 字节数 | 2                     | 1    | 1    | 4      | n    | 2   |
| ------ | --------------------- | ---- | ---- | ------ | ---- | --- |
| 定义   | 包大小(2+1+1+4+n+2)   | 0xff | 0x02 | 起始地址 | 数据 | CRC |

- 返回

| 字节数 | 1                                      |
| ------ | -------------------------------------- |
| 定义   | 0xaa(成功)<br>其它值(失败，参见错误码表) |

### 跳转到应用程序

- 发送

| 字节数 | 2         | 1    | 1    | 2   |
| ------ | --------- | ---- | ---- | --- |
| 定义   | 包大小(6) | 0xff | 0xff | CRC |

- 返回

| 字节数 | 1                                      |
| ------ | -------------------------------------- |
| 定义   | 0xaa(成功)<br>其它值(失败，参见错误码表) |

### 开始升级流程

- 发送

| 字节数 | 2          | 1    | 1    | 4         | 4         | 2   |
| ------ | ---------- | ---- | ---- | --------- | --------- | --- |
| 定义   | 包大小(14) | 0xff | 0x10 | 应用程序大小 | CRC32校验值 | CRC |

- 返回

| 字节数 | 1                                      |
| ------ | -------------------------------------- |
| 定义   | 0xaa(成功)<br>其它值(失败，参见错误码表) |

### 升级数据传输

- 发送

| 字节数 | 2                     | 1    | 1    | 4      | n    | 2   |
| ------ | --------------------- | ---- | ---- | ------ | ---- | --- |
| 定义   | 包大小(2+1+1+4+n+2)   | 0xff | 0x11 | 包序号  | 数据 | CRC |

- 返回

| 字节数 | 1                                      |
| ------ | -------------------------------------- |
| 定义   | 0xaa(成功)<br>其它值(失败，参见错误码表) |

### 完成升级流程

- 发送

| 字节数 | 2         | 1    | 1    | 2   |
| ------ | --------- | ---- | ---- | --- |
| 定义   | 包大小(6) | 0xff | 0x12 | CRC |

- 返回

| 字节数 | 1                                      |
| ------ | -------------------------------------- |
| 定义   | 0xaa(成功)<br>其它值(失败，参见错误码表) |

### Bootloader错误码

| 错误码 | 枚举值 | 含义                 |
| ------ | ------ | -------------------- |
| 0xAA   | UART_SUCCESS | 成功 |
| 0x01   | UART_ERROR_INVALID_PARAM | 无效参数 |
| 0x02   | UART_ERROR_CRC_MISMATCH | CRC校验错误 |
| 0x03   | UART_ERROR_UNKNOWN_CMD | 未知命令 |
| 0x04   | UART_ERROR_SIZE_MISMATCH | 大小不匹配 |
| 0x05   | UART_ERROR_FLASH_ERASE | Flash擦除失败 |
| 0x06   | UART_ERROR_FLASH_WRITE | Flash写入失败 |
| 0x07   | UART_ERROR_FLASH_VERIFY | Flash验证失败 |
| 0x08   | UART_ERROR_CRC_FAIL | CRC校验失败 |
